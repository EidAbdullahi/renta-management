{% extends "users/base.html" %}
{% block title %}Dashboard - Rental Management{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar for large screens -->
    <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-none d-md-block bg-light sidebar position-fixed vh-100 shadow-sm">
      <div class="pt-4">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active text-primary fw-bold" href="{% url 'dashboard' %}">
              <i class="bi bi-house-door me-2"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link dropdown-toggle" data-bs-toggle="collapse" href="#propertyMenu"><i class="bi bi-building me-2"></i> Properties</a>
            <div class="collapse" id="propertyMenu">
              <ul class="nav flex-column ms-3">
                <li><a class="nav-link" href="{% url 'add_property' %}">Add</a></li>
                <li><a class="nav-link" href="{% url 'property_list' %}">List</a></li>
              </ul>
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link dropdown-toggle" data-bs-toggle="collapse" href="#tenantMenu"><i class="bi bi-person-lines-fill me-2"></i> Tenants</a>
            <div class="collapse" id="tenantMenu">
              <ul class="nav flex-column ms-3">
                <li><a class="nav-link" href="{% url 'add_tenant' %}">Add</a></li>
                <li><a class="nav-link" href="{% url 'tenant_list' %}">List</a></li>
              </ul>
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link dropdown-toggle" data-bs-toggle="collapse" href="#paymentMenu"><i class="bi bi-credit-card me-2"></i> Financials</a>
            <div class="collapse" id="paymentMenu">
              <ul class="nav flex-column ms-3">
                <li><a class="nav-link" href="{% url 'payment_list' %}">Payment History</a></li>
                <li><a class="nav-link" href="{% url 'payment_summary' %}">Payment Summary</a></li>
                <li><a class="nav-link" href="{% url 'expense_list' %}">Expenses</a></li>
                <li><a class="nav-link" href="{% url 'financial_report' %}">Financial Report</a></li>
              </ul>
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link dropdown-toggle" data-bs-toggle="collapse" href="#vacancyMenu"><i class="bi bi-cash-stack me-2"></i> Vacancies</a>
            <div class="collapse" id="vacancyMenu">
              <ul class="nav flex-column ms-3">
                <li><a class="nav-link" href="{% url 'add_vacancy' %}">Add Vacancy</a></li>
                <li><a class="nav-link" href="{% url 'vacancy_list' %}">Vacancy List</a></li>
              </ul>
            </div>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main Content Area -->
    <main class="col-md-9 ms-sm-auto col-12 px-4 py-4">
      <!-- Top Bar -->
      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div class="d-md-none">
          <button class="btn btn-outline-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
            <i class="bi bi-list"></i> Menu
          </button>
        </div>
        <h2 class="h4 text-primary fw-bold">Dashboard Overview</h2>
        <div class="d-flex gap-2 align-items-center">
          <a href="{% url 'profile' %}" class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2">
            <img src="{{ user.profile.image.url }}" alt="Profile" class="rounded-circle" width="26" height="26">
            <span>Profile</span>
          </a>
          <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button class="btn btn-danger btn-sm">Logout</button>
          </form>
        </div>
      </div>

      <!-- Cards -->
      <div class="row g-3">
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card bg-primary text-white shadow-sm h-100">
            <div class="card-body">
              <h6>Total Tenants</h6>
              <h4>{{ total_tenants|default:0 }}</h4>
              <a href="{% url 'tenant_list' %}" class="btn btn-sm btn-light text-primary">View</a>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card bg-info text-white shadow-sm h-100">
            <div class="card-body">
              <h6>Employees</h6>
              <h4>{{ total_employees|default:0 }}</h4>
              <a href="{% url 'employee_list' %}" class="btn btn-sm btn-light text-info">View</a>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card bg-success text-white shadow-sm h-100">
            <div class="card-body">
              <h6>Occupied Units</h6>
              <h4>{{ total_occupied_units|default:0 }}</h4>
              <a href="{% url 'property_list' %}" class="btn btn-sm btn-light text-success">View</a>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card bg-secondary text-white shadow-sm h-100">
            <div class="card-body">
              <h6>Available Units</h6>
              <h4>{{ total_available_units|default:0 }}</h4>
              <a href="{% url 'property_list' %}" class="btn btn-sm btn-light text-dark">View</a>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card bg-warning text-dark shadow-sm h-100">
            <div class="card-body">
              <h6>Financial Reports</h6>
              <h4>{{ total_payment_list|default:0 }}</h4>
              <a href="{% url 'financial_report' %}" class="btn btn-sm btn-outline-dark">View</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="row mt-5">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <canvas id="paymentsChart" height="300"></canvas>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Offcanvas Mobile Sidebar -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileSidebar">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Menu</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <ul class="nav flex-column">
      <li><a class="nav-link active text-primary fw-bold" href="{% url 'dashboard' %}"><i class="bi bi-house-door me-2"></i> Dashboard</a></li>
      <li><a class="nav-link" href="{% url 'property_list' %}">Properties</a></li>
      <li><a class="nav-link" href="{% url 'tenant_list' %}">Tenants</a></li>
      <li><a class="nav-link" href="{% url 'payment_list' %}">Payments</a></li>
      <li><a class="nav-link" href="{% url 'expense_list' %}">Expenses</a></li>
      <li><a class="nav-link" href="{% url 'financial_report' %}">Reports</a></li>
    </ul>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('paymentsChart');
  if (ctx) {
    new Chart(ctx, {
      type: 'line', // Smooth curve chart
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr'], // Dynamic labels
        datasets: [{
          label: 'Payments',
          data: [500, 1000, 750, 1250], // Sample dynamic data
          borderColor: 'rgba(54, 162, 235, 1)', 
          backgroundColor: 'rgba(54, 162, 235, 0.2)', 
          tension: 0.4, 
          fill: true,
          pointBackgroundColor: 'rgba(54, 162, 235, 1)', 
          pointRadius: 5, 
        }]
      },
      options: {
        responsive: true, 
        maintainAspectRatio: false, 
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true, ticks: { callback: function(value) { return '$' + value; } } }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(tooltipItem) {
                return '$' + tooltipItem.raw;
              }
            }
          }
        }
      }
    });
  }
</script>
{% endblock %}

{% block styles %}
<style>
  /* Media Query for Mobile and Tablets */
  @media (max-width: 768px) {
    main {
      margin-left: 0 !important;
    }
    #sidebarMenu {
      position: static;
      height: auto;
      box-shadow: none;
    }
    .card-body {
      padding: 1rem;
    }
  }

  canvas {
    max-width: 100%;
  }

  .sidebar {
    min-height: 100vh;
    background-color: #f8f9fa;
    overflow-y: auto;
  }

  .offcanvas-body .nav-link {
    font-size: 1.1rem;
  }

  .btn-light {
    border: none;
  }
</style>
{% endblock %}
