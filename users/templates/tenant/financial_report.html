{% extends "users/base.html" %}
{% block title %}Dashboard - Rental Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar (Mobile friendly, collapsible) -->
      
      <!-- Sidebar for large screens -->
    <nav id="sidebarMenu" class="col-md-2 bg-light sidebar shadow-sm vh-100 d-none d-md-block position-fixed">
      <div class="pt-4">
        <ul class="nav flex-column">
          <li class="nav-item"><a class="nav-link active text-primary fw-bold" href="{% url 'dashboard' %}"><i class="bi bi-house-door me-2"></i>Dashboard</a></li>
          <li class="nav-item">
            <a class="nav-link dropdown-toggle" data-bs-toggle="collapse" href="#propertyMenu"><i class="bi bi-building me-2"></i>Properties</a>
            <div class="collapse" id="propertyMenu">
              <ul class="nav flex-column ms-3">
                <li><a class="nav-link" href="{% url 'add_property' %}">Add</a></li>
                <li><a class="nav-link" href="{% url 'property_list' %}">List</a></li>
              </ul>
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link dropdown-toggle" data-bs-toggle="collapse" href="#tenantMenu"><i class="bi bi-person-lines-fill me-2"></i>Tenants</a>
            <div class="collapse" id="tenantMenu">
              <ul class="nav flex-column ms-3">
                <li><a class="nav-link" href="{% url 'add_tenant' %}">Add</a></li>
                <li><a class="nav-link" href="{% url 'tenant_list' %}">List</a></li>
              </ul>
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link dropdown-toggle" data-bs-toggle="collapse" href="#paymentMenu"><i class="bi bi-credit-card me-2"></i>Financials</a>
            <div class="collapse" id="paymentMenu">
              <ul class="nav flex-column ms-3">
                <li><a class="nav-link" href="{% url 'payment_list' %}"> Payment History</a></li>
                <li><a class="nav-link" href="{% url 'payment_summary' %}">Payment Summary</a></li>
                <li><a class="nav-link" href="{% url 'expense_list' %}"> Expenses</a></li>
                <li><a class="nav-link" href="{% url 'financial_report' %}">Financial report</a></li>
              </ul>
            </div>
          </li>
         
        </ul>
      </div>
    </nav>
        <!-- Mobile Menu Toggle Button -->
        <div class="col-12 d-md-none text-end mb-3">
            <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle sidebar">
                <i class="bi bi-list"></i> Menu
            </button>
        </div>

        <!-- Main Content -->
        <main class="col-md-10 ms-sm-auto px-md-5 py-4">
            <div class="container mt-4">
              <div class="mb-3">
                <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-secondary shadow-sm">
                    <i class="bi bi-arrow-left-circle"></i> Back to Dashboard
                </a>
            </div>
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                    <h4 class="text-primary fw-bold">üè† Financial Report</h4>
                    <div>
                        <!-- Month Selector Form -->
                        <form method="get" class="d-flex gap-2">
                          <select name="month" class="form-select">
                              {% for num, name in month_choices %}
                                  <option value="{{ num }}" {% if selected_month == num %}selected{% endif %}>{{ name }}</option>
                              {% endfor %}
                          </select>
                          <button type="submit" class="btn btn-primary">Filter</button>
                      </form>
                        <button class="btn btn-outline-primary btn-sm shadow-sm" onclick="printTable()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>

                <!-- Financial Summary Cards (Responsive) -->
                <div class="row mb-4">
                    <div class="col-12 col-md-4 mb-3 mb-md-0">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title text-primary">Total Income</h5>
                                <p class="fs-3 fw-bold">KES {{ report_summary.total_income }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4 mb-3 mb-md-0">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title text-danger">Total Expense</h5>
                                <p class="fs-3 fw-bold">KES {{ report_summary.total_expenses }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title text-success">Net Income</h5>
                                <p class="fs-3 fw-bold">KES {{ report_summary.net_profit }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Graphs (Responsive) -->
                <div class="row mb-4">
                    <div class="col-12 col-md-6 mb-3 mb-md-0">
                        <canvas id="incomeChart"></canvas>
                    </div>
                    <div class="col-12 col-md-6">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>

                <!-- Financial Report Table -->
                <div class="table-responsive" style="max-height: 400px; overflow-x: auto;">
                    <table class="table table-sm table-bordered table-striped table-hover text-center align-middle shadow-sm" id="tenantTable">
                        <thead class="table-primary">
                            <tr>
                                <th>Total Income in Rent</th>
                                <th>Total Expense</th>
                                <th>Net Income</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="fw-semibold">KES {{ report_summary.total_income }}</td>
                                <td class="fw-semibold">KES {{ report_summary.total_expenses }}</td>
                                <td>KES {{ report_summary.net_profit }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

{% endblock %}

<!-- JavaScript for Live Search Filtering and Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Print Table Function
  function printTable() {
    const printContent = document.getElementById("tenantTable").outerHTML;
    const newWindow = window.open('', '', 'width=800,height=600');
    newWindow.document.write(`
      <html>
      <head>
        <title>Financial Report</title>
        <style>
          body {
            font-family: Arial, sans-serif;
            padding: 20px;
          }
          table {
            width: 100%;
            border-collapse: collapse;
          }
          th, td {
            border: 1px solid #000;
            padding: 10px;
            text-align: center;
          }
          th {
            background-color: #007bff;
            color: #fff;
          }
          h2 {
            text-align: center;
            margin-bottom: 20px;
          }
        </style>
      </head>
      <body>
        <h2>üè† Financial Report</h2>
        ${printContent}
      </body>
      </html>
    `);
    newWindow.document.close();
    newWindow.focus();
    newWindow.print();
    newWindow.close();
  }

  // Create the income chart
  const incomeChart = new Chart(document.getElementById('incomeChart'), {
    type: 'bar',
    data: {
      labels: ['Total Income'],
      datasets: [{
        label: 'Total Income in KES',
        data: [{{ report_summary.total_income }}],
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // Create the expense chart
  const expenseChart = new Chart(document.getElementById('expenseChart'), {
    type: 'pie',
    data: {
      labels: ['Expenses'],
      datasets: [{
        label: 'Total Expenses in KES',
        data: [{{ report_summary.total_expenses }}],
        backgroundColor: ['rgba(255, 99, 132, 0.2)'],
        borderColor: ['rgba(255, 99, 132, 1)'],
        borderWidth: 1
      }]
    }
  });
</script>
