{% extends "users/base.html" %}
{% block title %}Dashboard - Rental Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar (Mobile friendly, collapsible) -->
        <nav id="sidebar" class="col-md-2 d-none d-md-block bg-light sidebar vh-100 shadow-sm">
            <div class="position-sticky pt-4">
                <h5 class="text-center text-primary fw-bold mb-4">Dashboard Menu</h5>
                <ul class="nav flex-column">
                    <li class="nav-item mb-2">
                        <a class="nav-link active text-primary" href="{% url 'dashboard' %}">
                            <i class="bi bi-house-door me-2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="{% url 'tenant_list' %}">
                            <i class="bi bi-person me-2"></i> Rent history
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="{% url 'expense_list' %}">
                            <i class="bi bi-wallet me-2"></i> Expenses
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="{% url 'payment_list' %}">
                            <i class="bi bi-tools me-2"></i> Financial analysis
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Mobile Menu Toggle Button -->
        <div class="col-12 d-md-none text-end mb-3">
            <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle sidebar">
                <i class="bi bi-list"></i> Menu
            </button>
        </div>

        <!-- Main Content -->
        <main class="col-md-10 ms-sm-auto px-md-5 py-4">
            <div class="container mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                    <h4 class="text-primary fw-bold">üè† Financial Report</h4>
                    <div>
                        <!-- Month Selector Form -->
                        <form method="GET" class="d-inline-block">
                            <select name="month" class="form-select form-select-sm" id="monthSelect">
                                <option value="1" {% if selected_month == 1 %}selected{% endif %}>January</option>
                                <option value="2" {% if selected_month == 2 %}selected{% endif %}>February</option>
                                <option value="3" {% if selected_month == 3 %}selected{% endif %}>March</option>
                                <option value="4" {% if selected_month == 4 %}selected{% endif %}>April</option>
                                <option value="5" {% if selected_month == 5 %}selected{% endif %}>May</option>
                                <option value="6" {% if selected_month == 6 %}selected{% endif %}>June</option>
                                <option value="7" {% if selected_month == 7 %}selected{% endif %}>July</option>
                                <option value="8" {% if selected_month == 8 %}selected{% endif %}>August</option>
                                <option value="9" {% if selected_month == 9 %}selected{% endif %}>September</option>
                                <option value="10" {% if selected_month == 10 %}selected{% endif %}>October</option>
                                <option value="11" {% if selected_month == 11 %}selected{% endif %}>November</option>
                                <option value="12" {% if selected_month == 12 %}selected{% endif %}>December</option>
                            </select>
                            <button type="submit" class="btn btn-outline-primary btn-sm ms-2">Filter</button>
                        </form>
                        <button class="btn btn-outline-primary btn-sm shadow-sm" onclick="printTable()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>

                <!-- Financial Summary Cards (Responsive) -->
                <div class="row mb-4">
                    <div class="col-12 col-md-4 mb-3 mb-md-0">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title text-primary">Total Income</h5>
                                <p class="fs-3 fw-bold">KES {{ report_summary.total_income }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4 mb-3 mb-md-0">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title text-danger">Total Expense</h5>
                                <p class="fs-3 fw-bold">KES {{ report_summary.total_expenses }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title text-success">Net Income</h5>
                                <p class="fs-3 fw-bold">KES {{ report_summary.net_profit }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Graphs (Responsive) -->
                <div class="row mb-4">
                    <div class="col-12 col-md-6 mb-3 mb-md-0">
                        <canvas id="incomeChart"></canvas>
                    </div>
                    <div class="col-12 col-md-6">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>

                <!-- Financial Report Table -->
                <div class="table-responsive" style="max-height: 400px; overflow-x: auto;">
                    <table class="table table-sm table-bordered table-striped table-hover text-center align-middle shadow-sm" id="tenantTable">
                        <thead class="table-primary">
                            <tr>
                                <th>Total Income in Rent</th>
                                <th>Total Expense</th>
                                <th>Net Income</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="fw-semibold">KES {{ report_summary.total_income }}</td>
                                <td class="fw-semibold">KES {{ report_summary.total_expenses }}</td>
                                <td>KES {{ report_summary.net_profit }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

{% endblock %}

<!-- JavaScript for Live Search Filtering and Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Print Table Function
  function printTable() {
    const printContent = document.getElementById("tenantTable").outerHTML;
    const newWindow = window.open('', '', 'width=800,height=600');
    newWindow.document.write(`
      <html>
      <head>
        <title>Financial Report</title>
        <style>
          body {
            font-family: Arial, sans-serif;
            padding: 20px;
          }
          table {
            width: 100%;
            border-collapse: collapse;
          }
          th, td {
            border: 1px solid #000;
            padding: 10px;
            text-align: center;
          }
          th {
            background-color: #007bff;
            color: #fff;
          }
          h2 {
            text-align: center;
            margin-bottom: 20px;
          }
        </style>
      </head>
      <body>
        <h2>üè† Financial Report</h2>
        ${printContent}
      </body>
      </html>
    `);
    newWindow.document.close();
    newWindow.focus();
    newWindow.print();
    newWindow.close();
  }

  // Create the income chart
  const incomeChart = new Chart(document.getElementById('incomeChart'), {
    type: 'bar',
    data: {
      labels: ['Total Income'],
      datasets: [{
        label: 'Total Income in KES',
        data: [{{ report_summary.total_income }}],
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // Create the expense chart
  const expenseChart = new Chart(document.getElementById('expenseChart'), {
    type: 'pie',
    data: {
      labels: ['Expenses'],
      datasets: [{
        label: 'Total Expenses in KES',
        data: [{{ report_summary.total_expenses }}],
        backgroundColor: ['rgba(255, 99, 132, 0.2)'],
        borderColor: ['rgba(255, 99, 132, 1)'],
        borderWidth: 1
      }]
    }
  });
</script>
