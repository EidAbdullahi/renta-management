{% extends "users/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="mb-3">
        <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-secondary shadow-sm">
            <i class="bi bi-arrow-left-circle"></i> Back to Dashboard
        </a>
    </div>
    <div class="card p-4">
        <h2 class="mb-4 text-center text-primary">Expense List</h2>
        <p class="total-expenses">Total Expenses for {{ month|default:"All Months" }}:
            <strong>KES {{ total_expenses }}</strong></p>

        <!-- Filter Section -->
        <div class="filter-container mb-4">
            <input type="text" id="expenseSearch" class="form-control w-50 search-bar" placeholder="🔍 Search Expenses..." onkeyup="filterTable()">
            <select id="monthFilter" class="form-control month-filter" onchange="filterByMonth()">
                <option value="">Select Month</option>
                {% for m in months %}
                    <option value="{{ m.0 }}" {% if month == m.0 %}selected{% endif %}>
                        {{ m.1 }}
                    </option>
                {% endfor %}
            </select>
            <div>
                <a href="{% url 'add_expense' %}" class="btn btn-primary mb-3">+ Add New Expense</a>
                <button class="btn btn-secondary mb-3" onclick="printTable()">📄 Print</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-striped" id="expenseTable">
                <thead>
                    <tr>
                        <th>Expense Type</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in expenses %}
                        <tr data-date="{{ expense.expense_date|date:"Y-m-d" }}">
                            <td>{{ expense.get_expense_type_display }}</td>
                            <td>KES {{ expense.amount }}</td>
                            <td>{{ expense.expense_date }}</td>
                            <td>{{ expense.description }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">No expenses recorded yet.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 1rem;
        box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.05);
    }

    .table thead {
        background-color: #007bff;
        color: white;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f1f1f1;
    }

    .btn {
        border-radius: 0.5rem;
    }

    h2 {
        font-weight: 600;
    }

    .total-expenses {
        font-size: 1.2rem;
        font-weight: bold;
    }

    .filter-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .month-filter {
        width: 200px;
    }

    .search-bar {
        width: 100%;
        max-width: 400px;
    }
</style>

<script>
    function filterTable() {
        let input = document.getElementById("expenseSearch").value.toLowerCase();
        let table = document.getElementById("expenseTable");
        let rows = table.getElementsByTagName("tr");

        for (let i = 1; i < rows.length; i++) {
            let cells = rows[i].getElementsByTagName("td");
            let rowText = "";
            for (let cell of cells) {
                rowText += cell.textContent.toLowerCase() + " ";
            }
            rows[i].style.display = rowText.includes(input) ? "" : "none";
        }
    }

    function filterByMonth() {
        let month = document.getElementById("monthFilter").value;
        window.location.href = `?month=${month}`;
    }

    function printTable() {
        let printContent = document.getElementById("expenseTable").outerHTML;
        let newWin = window.open("");
        newWin.document.write(`
            <html>
            <head>
                <title>Print Expense List</title>
                <style>
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid black; padding: 8px; text-align: center; }
                    th { background-color: #007bff; color: white; }
                </style>
            </head>
            <body>
                <h2 style="text-align:center;">Expense List</h2>
                ${printContent}
            </body>
            </html>
        `);
        newWin.print();
        newWin.close();
    }
</script>
{% endblock %}
